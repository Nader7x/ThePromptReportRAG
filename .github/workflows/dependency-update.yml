name: ğŸ”„ Update Dependencies

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      update_type:
        description: "Type of update"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

env:
  PYTHON_VERSION: "3.11"

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: ğŸ“¦ Update Dependencies

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CR_PAT }}
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ğŸ“¦ Install tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools pur

      - name: ğŸ”„ Update requirements
        run: |
          echo "ğŸ”„ Updating dependency files..."

          # Update requirements.txt
          if [ -f "requirements.txt" ]; then
            echo "ğŸ“¦ Updating requirements.txt"
            pur -r requirements.txt --force
          fi

          # Update optional requirements
          if [ -f "requirements-optional.txt" ]; then
            echo "ğŸ“¦ Updating requirements-optional.txt"
            pur -r requirements-optional.txt --force
          fi

          # Update dev requirements
          if [ -f "requirements-dev.txt" ]; then
            echo "ğŸ“¦ Updating requirements-dev.txt"
            pur -r requirements-dev.txt --force
          fi

          # Show what changed
          echo "ğŸ“‹ Changes made:"
          git diff --name-only || echo "No changes detected"

      - name: ğŸ§ª Test updated dependencies
        run: |
          echo "ğŸ§ª Testing updated dependencies..."

          # Install updated dependencies
          pip install -r requirements.txt

          # Install dev dependencies if available
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          fi

          # Test core imports
          python -c "
          import sys
          import traceback

          test_modules = [
              'google.generativeai',
              'streamlit', 
              'fastapi',
              'numpy',
              'pandas',
              'requests',
              'faiss',
              'sentence_transformers'
          ]

          failed_imports = []

          for module in test_modules:
              try:
                  __import__(module)
                  print(f'âœ… {module}')
              except ImportError as e:
                  print(f'âŒ {module}: {e}')
                  failed_imports.append(module)
              except Exception as e:
                  print(f'âš ï¸ {module}: {e}')

          if failed_imports:
              print(f'âŒ Failed to import: {failed_imports}')
              sys.exit(1)
          else:
              print('âœ… All core dependencies imported successfully')
          "

          # Test basic app syntax
          echo "ğŸ” Testing app syntax..."
          python -m py_compile streamlit_app.py
          echo "âœ… streamlit_app.py syntax check passed"

      - name: ğŸ“ Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CR_PAT }}
          commit-message: "ğŸ“¦ Update dependencies (${{ github.event.inputs.update_type || 'scheduled' }})"
          title: "ğŸ“¦ Dependency Updates (${{ github.event.inputs.update_type || 'scheduled' }})"
          body: |
            ğŸ¤– **Automated Dependency Update**

            This PR updates the project dependencies to their latest versions.

            ### Changes
            - â¬†ï¸ Updated `requirements.txt`
            - â¬†ï¸ Updated `requirements-optional.txt` (if exists)
            - â¬†ï¸ Updated `requirements-dev.txt` (if exists)

            ### Update Type
            **Type:** ${{ github.event.inputs.update_type || 'Scheduled weekly update' }}

            ### Testing Status
            - âœ… Basic import tests passed
            - âœ… App syntax validation passed
            - âš ï¸ Please review changes and run full test suite

            ### Review Checklist
            - [ ] Review dependency changes for breaking changes
            - [ ] Test the Streamlit app locally
            - [ ] Verify API functionality
            - [ ] Check for any new security vulnerabilities
            - [ ] Ensure compatibility with current Python version (${{ env.PYTHON_VERSION }})

            ### Notes
            - All core dependencies were successfully imported
            - No syntax errors detected in main application files
            - Consider testing on the deployed Streamlit app before merging

            ---
            *This PR was created automatically by GitHub Actions*

            **Triggered by:** ${{ github.event_name }}
            **Actor:** ${{ github.actor }}
            **Workflow:** ${{ github.workflow }}
          branch: dependency-updates
          delete-branch: true
          draft: false

      - name: ğŸ·ï¸ Add labels to PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:dependency-updates`,
              state: 'open'
            });

            if (prs.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs[0].number,
                labels: ['dependencies', 'automated', 'maintenance']
              });
            }
